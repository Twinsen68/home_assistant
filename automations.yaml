- alias: Backup HA Configuration Files
  id: backup_config_files
  trigger:
    platform: time_pattern
    hours: 1
    minutes: 1
    seconds: 0 
  condition:
    condition: time
    weekday:
      - wed
  action:
    - service: shell_command.backup_configuration

#Set Theme
- alias: 'Set Theme to Midnight'
  initial_state: 'on'
  trigger:
  - platform: homeassistant
    event: start
  action:
  - service: frontend.set_theme
    data:
      name: midnight

- alias: Occupancy On
  hide_entity: true
  trigger:
    - platform: state
      entity_id: binary_sensor.people_home
      from: "off"
      to: "on"
  action:
    - service: input_boolean.turn_on
      data:
        entity_id: input_boolean.occupancy

- alias: Occupancy Off
  hide_entity: true
  trigger:
    - platform: state
      entity_id: binary_sensor.people_home
      from: "on"
      to: "off"
  action:
    - service: input_boolean.turn_off
      data:
        entity_id: input_boolean.occupancy

- alias: Turn Off Lights on Leaving Home Zone
  id: gabe_out_of_home_zone_lights_off
  trigger:
#    - platform: state
#      entity_id: device_tracker.huawei_mate_9_92528f2b1a5
#      from: 'home'
#      to: 'not_home'
    - platform: state
      entity_id: binary_sensor.people_home
      from: 'on'
      to: 'off'
      for:
          hours: 0
          minutes: 15
          seconds: 0
    - platform: numeric_state
      entity_id: sensor.home_occupancy_confidence
      below: 51
      for:
          hours: 0
          minutes: 15
          seconds: 0
  action:
    - service: homeassistant.turn_off
      data:
        entity_id: group.all_lightbulbs

- alias: Turn On Lights on Enter Home Zone
  id: gabe_arrive_in_home_zone_lights_on
  trigger:
#    - platform: zone
#      entity_id: device_tracker.5re0217120001465
#      zone: zone.home
#      event: enter
#    - platform: zone
#      entity_id: device_tracker.huawei_mate_9_92528f2b1a5
#      zone: zone.home
#      event: enter
    - platform: state
      entity_id: binary_sensor.people_home
      from: 'off'
      to: 'on'
  action:
    - service: switch.turn_on
      entity_id: switch.entry_light

#- alias: Deactivate Detect on Enter Home Zone
#  id: gabe_arrive_in_home_zone_motion_off
#  trigger:
#    - platform: zone
#      entity_id: device_tracker.5re0217120001465
#      zone: zone.home
#      event: enter
#    - platform: zone
#      entity_id: device_tracker.huawei_mate_9_92528f2b1a5
#      zone: zone.home
#      event: enter
#    - platform: numeric_state
#      entity_id: sensor.home_occupancy_confidence
#      above: 70
#    - platform: state
#      entity_id: binary_sensor.people_home
#      from: 'off'
#      to: 'on'
#  action:
#    - service: homeassistant.turn_off
#      data:
#        entity_id: switch.motion_detect

- alias: Welcome on Enter Home Zone
  id: gabe_arrive_in_home_zone_welcome
  trigger:
    - platform: state
      entity_id: input_select.gabe_status_dropdown
      to: "Just Arrived"
#  condition:
#    condition: template
#    value_template: '{{ as_timestamp(now()) - as_timestamp(states.automation.gabe_arrive_in_home_zone_welcome.attributes.last_triggered) | int > 10800 }}'
  action:
    - service: script.janet_speech_engine
      data:
        call_greeting_gabe: 1
    - service: script.turn_on
      entity_id: script.welcome_lights_on

- alias: Mom welcome
  id: mom_arrive_in_home_zone_welcome
  trigger:
    - platform: zone
      entity_id: group.berny
      zone: zone.home
      event: enter
  condition:
    condition: template
    value_template: '{{ as_timestamp(now()) - as_timestamp(states.automation.mom_arrive_in_home_zone_welcome.attributes.last_triggered) | int > 10800 }}'
  action:
    - service: script.janet_speech_engine
      data:
        call_greeting_berny: 1

#Morning Greeting
- alias: 'Morning Greeting'
  id: morning_greeting_update
  trigger:
    platform: state
#    entity_id: binary_sensor.kiosk_att_motion
    entity_id: binary_sensor.dashboard_motion
    from: 'off'
    to: 'on'
  condition:
    condition: and
    conditions:
#      - condition: time
#        before: '10:30:00'
#        after: '07:30:00'
      - condition: state
        entity_id: input_boolean.alarm_went_off
        state: 'on'
      - condition: template
        value_template: '{{ as_timestamp(now()) - as_timestamp(states.automation.morning_greeting.attributes.last_triggered) | int > 10800 }}'
  action:
    - service: script.turn_on
      entity_id: script.kiosk_good_morning

#Download News once a day
- alias: 'download_npr_news'
  trigger:
    - platform: time
      at: '06:16:00'
  action:
    - service: downloader.download_file
      data_template:
        url: "{{ states('sensor.npr_news_mp3_link') }}"
        filename: "npr_news.mp3"
        overwrite: true

#Dim Kiosk with light
- alias: 'Dim Kiosk Screen'
  id: dim_kiosk_screen
  trigger:
    platform: state
    entity_id: light.entry_light
    from: 'on'
    to: 'off'
  action:
    - service: rest_command.kiosk_screen_dim

#Bright Kiosk with light
- alias: 'Brighten Kiosk Screen'
  id: brihten_kiosk_screen
  trigger:
    platform: state
    entity_id: light.entry_light
    from: 'off'
    to: 'on'
  action:
    - service: rest_command.kiosk_screen_mid

- alias: Turn off kiosk charger
  trigger:
    platform: template
    value_template: "{{ 80 < states.light.dashboard_screen.attributes.battery_level }}"
  action:
    service: switch.turn_off
    entity_id: switch.2437254184f3eb69e784

- alias: Turn on kiosk charger
  trigger:
    platform: template
    value_template: "{{ 20 > states.light.dashboard_screen.attributes.battery_level }}"
  action:
    service: switch.turn_on
    entity_id: switch.2437254184f3eb69e784

#- alias: Home Assistant Start
#  trigger:
#    platform: homeassistant
#    event: start 
#  action:
#    - delay: '00:00:10'
#    - service: notify.kiosk
#      data:
#        message: 'Home Assistant has started'

- alias: Start Up
  trigger:
    - event: start
      platform: homeassistant    
  action:
    - delay: '00:00:10'  
#    - wait_template: "{{ not is_state( media_player.kiosk_speaker, 'playing') }}"
#      timeout: 00:00:10
    - service: rest_command.kiosk_sound_battle
    - service: notify.html5_push
      data:
        data:
          renotify: 1
          icon: https://thisisgabes.asuscomm.com:8008/local/icons/smarthome.png
          badge: https://thisisgabes.asuscomm.com:8008/local/icons/badge_smarthome.png
          timestamp: '%m'
          url: https://thisisgabes.asuscomm.com:8008
          vibrate: 700, 700, 700
        message: "Home Assistant restarted at {{ as_timestamp(now()) | timestamp_custom('%H:%M', true) }}"
        title: "Hello World!"
        target:
          - "Gabes Mate"
          - "Macbook"
    - delay:
        seconds: 6
    - service: notify.kiosk
      data:
        message: 'Home Assistant has started'
    - delay:
        seconds: 5  
    - service: script.janet_speech_engine
      data:
        call_introduction: 1 
    - delay:
        seconds: 10  
    - service: alexa_media.update_last_called 
    - delay:
        seconds: 5 
    - service: notify.alexa_media
      data:
        data:
          type: tts
        target: 
          - media_player.gabe_s_alexa
        message: 'Alexa Tee Tee Ess is Connected' 

#SSL Expiry
- alias: ssl_expiry_notify
  trigger:
    platform: numeric_state
    entity_id: sensor.ssl_certificate_expiry
    below: 2
  condition:
    condition: time
    after: '13:00:00'
  action:
    - service: notify.html5_push
      data:
        data:
          renotify: 1
          icon: https://thisisgabes.asuscomm.com:8008/local/icons/ssl.png
          badge: https://thisisgabes.asuscomm.com:8008/local/icons/badge_calendar.png
          timestamp: '%m'
          url: https://thisisgabes.asuscomm.com:8008/lovelace/10
          vibrate: 700, 700, 700
        message: "Your SSL cert expires in {{ states.sensor.ssl_certificate_expiry.state }} days."
        title: "Beep! Boop!"
        target:
          - "Gabes Mate"
          - "Macbook"
    - service: script.janet_speech_engine
      data:
        message: "Hey Gabe, I just want to let you know that your website SSL certificate expires in {{ states.sensor.ssl_certificate_expiry.state }} days. You have instructions on how to renew it saved in your evernote app."
    - service: persistent_notification.create
      data:
        message: "Your SSL cert expires in {{ states.sensor.ssl_certificate_expiry.state }} days."
        title: "Beep! Boop!"

- alias: Set Harmony activity
  hide_entity: True
  trigger:
    platform: state
    entity_id: input_select.harmony
  action:
    service: remote.turn_on
    entity_id: remote.gabes_harmony_hub
    data_template:
      activity: >
        {% if is_state("input_select.harmony", "Speaker") %}
          29883813
        {% elif is_state("input_select.harmony", "Fishtank Evening") %}
          25723108
        {% elif is_state("input_select.harmony", "Watch Roku") %}
          26106880
        {% elif is_state("input_select.harmony", "Watch a Movie") %}
          26106724
        {% elif is_state("input_select.harmony", "Fishtank Morning") %}
          25723061
        {% else %}
          -1
        {% endif %}
        
# This next automation is to update the input_select when the Harmony's
# activity was changed from somewhere else, e.g. using its physical remote.
- alias: Update Harmony input_select
  hide_entity: True
  trigger:
    platform: state
    entity_id: remote.gabes_harmony_hub
  action:
    service: input_select.select_option
    data_template:
      entity_id: input_select.harmony
      option: "{{ states.remote.harmony_hub.attributes.current_activity }}"

## Reef Tides Wavemaker
#- alias: Turn on Wavemaker at high tide
#  trigger:
#    platform: template
#    value_template: '{{ strptime(states.sensor.time_utc.state , "%H:%M") == strptime(states.sensor.reef_time_high_tide.state , "%H:%M") }}'
#  action:
#    service: switch.turn_on
#    entity_id: switch.06200940dc4f22cbb94b_2

#- alias: Turn off Wavemaker at low tide
#  trigger:
#    platform: template
#    value_template: '{{ strptime(states.sensor.time_utc.state , "%H:%M") == strptime(states.sensor.reef_time_low_tide.state , "%H:%M") }}'
#  action:
#    service: script.turn_on
#    entity_id: script.reef_waves_lowtide_fade_script

## Amazon Tides Wavemaker
- alias: Turn on Amazon Waves at high tide
  trigger:
    platform: template
    value_template: '{{ strptime(states.sensor.time.state , "%k:%M") == strptime(states.sensor.amazonnexthightide.state , "%k:%M") }}'
  action:
    service: script.turn_on
    entity_id: script.freshwater_waves_on_script

- alias: Turn on Amazon Waves again at low tide
  trigger:
    platform: template
    value_template: '{{ strptime(states.sensor.time.state , "%k:%M") == strptime(states.sensor.amazonnextlowtide.state , "%k:%M") }}'
  action:
    service: script.turn_on
    entity_id: script.freshwater_waves_on_script

#Sunrise Sunset on Tanks
#- alias: Start Fade Down of Reef Lights at Sunset
#  trigger:
#    platform: template
#    value_template: "{{ strptime(states.sensor.time.state , '%k:%M') == strptime(states.sensor.reefsunsettides.state , '%k:%M') }}"
#  action:
#  - service: script.turn_on
#    entity_id: script.reeftank_evening_fade_kessil

#- alias: Start Fade Up of Reef Lights at Sunrise
#  trigger:
#    platform: template
#    value_template: "{{ strptime(states.sensor.time.state , '%H:%M') == strptime(states.sensor.reefsunrisetides.state , '%H:%M') }}"
#  action:
#  - service: script.turn_on
#    entity_id: script.reeftank_morning_fade_kessil

#Sunrise Sunset on Reef Tank Diurnal Phasing
- alias: Set sunrise and set with reef-pi
  trigger:
    platform: time
    at: '04:15:00'
  action:
  - service: rest_command.set_diurnal_reef_lights

- alias: Turn Off Reef Lights Outlet at Sunset
  trigger:
    platform: template
    value_template: "{{ strptime(states.sensor.time.state , '%k:%M') == strptime(states.sensor.reeftime_sunset_adjustment.state , '%k:%M') }}"
  action:
  - service: script.turn_on
    entity_id: script.reeftank_evening_outlet_kessil

- alias: Turn On Reef Lights Outlet at Sunrise
  trigger:
    platform: template
    value_template: "{{ strptime(states.sensor.time.state , '%H:%M') == strptime(states.sensor.reeftime_sunrise_adjustment.state , '%H:%M') }}"
  action:
  - service: script.turn_on
    entity_id: script.reeftank_morning_outlet_kessil

#Moonrise Moonset on Tanks
- alias: Stop Reef Moon
  trigger:
    platform: template
    value_template: "{{ strptime(states.sensor.time.state , '%k:%M') == strptime(states.sensor.reefmoonrisetides.state , '%k:%M') }}"
  condition:
    condition: numeric_state
    entity_id: sensor.reef_weather_moon_phase_1d
    above: .35
    below: .65 
  action:
  - service: script.turn_on
    entity_id: script.reeftank_moon_off

- alias: Start Reef Moon
  trigger:
    platform: template
    value_template: "{{ strptime(states.sensor.time.state , '%k:%M') == strptime(states.sensor.reefmoonrisetides.state , '%k:%M') }}"
  condition:
    condition: or
    conditions:
      - condition: numeric_state
        entity_id: sensor.reef_weather_moon_phase_1d
        above: .38
        below: .48 
      - condition: numeric_state
        entity_id: sensor.reef_weather_moon_phase_1d
        above: .53
        below: .63 
  action:
  - service: script.turn_on
    entity_id: script.reeftank_moon_on
  - service: script.turn_on
    entity_id: script.reeftank_moon_up

- alias: Stronger Fade Up of Reef Moon
  trigger:
    platform: template
    value_template: "{{ strptime(states.sensor.time.state , '%k:%M') == strptime(states.sensor.reefmoonrisetides.state , '%k:%M') }}"
  condition:
    condition: or
    conditions:
      - condition: numeric_state
        entity_id: sensor.reef_weather_moon_phase_1d
        above: .48
        below: .49 
      - condition: numeric_state
        entity_id: sensor.reef_weather_moon_phase_1d
        above: .51
        below: .53 
  action:
  - service: script.turn_on
    entity_id: script.reeftank_moon_on
  - service: script.turn_on
    entity_id: script.reeftank_moon_up_stronger

- alias: Reef Full Moon
  trigger:
    platform: template
    value_template: "{{ strptime(states.sensor.time.state , '%k:%M') == strptime(states.sensor.reefmoonrisetides.state , '%k:%M') }}"
  condition:
    condition: numeric_state
    entity_id: sensor.reef_weather_moon_phase_1d
    above: .49
    below: .51 
  action:
  - service: script.turn_on
    entity_id: script.reeftank_moon_on
  - service: script.turn_on
    entity_id: script.reeftank_full_moon

- alias: Freshwater Lights and O2 On at Sunrise
  trigger:
    platform: template
    value_template: "{{ strptime(states.sensor.time.state , '%H:%M') == strptime(states.sensor.amazonsunrisetides.state , '%H:%M') }}"
  action:
  - service: script.turn_on
    entity_id: script.octotank_morning_on

- alias: Freshwater Lights and O2 Off at Sunset
  trigger:
    platform: template
    value_template: "{{ strptime(states.sensor.time.state , '%H:%M') == strptime(states.sensor.amazonsunsettides.state , '%H:%M') }}"
  action:
  - service: script.turn_on
    entity_id: script.octotank_evening_off

# Amazon Feeder
- alias: Activate Feeder Script Morning
  trigger:
    platform: time
    at: '09:15:00'
  action:
  - service: script.turn_on
    entity_id: script.freshwater_feeder_script

#- alias: Activate Feeder Script MidDay
#  trigger:
#    platform: time
#    at: '12:15:00'
#  action:
#  - service: script.turn_on
#    entity_id: script.freshwater_feeder_script

- alias: Activate Feeder Script Afternoon
  trigger:
    platform: time
    at: '17:30:00'
  action:
  - service: script.turn_on
    entity_id: script.freshwater_feeder_script

## Amazon Temp Regulation
# This automation script runs when a value is received via Amazon sensor: monthly_amazon_temp
- alias: Set Amazon Thermostat Max Daytime Selector
  trigger:
    platform: template
    value_template: "{{ states.sensor.monthly_amazon_temp_lowmed.state != states.climate.octo_tank_therm.attributes.temperature.state }}"
  condition:
    condition: state
    entity_id: switch.06200940dc4f22cbb432_4
    state: 'on'
  action:
     service: climate.set_temperature
     data_template:
       entity_id: climate.octo_tank_therm
       temperature: '{{ states.sensor.monthly_amazon_temp_lowmed.state | float }}'

 # This automation script runs when a value is received via Amazon sensor: monthly_amazon_temp
- alias: Set Amazon Thermostat Max Night Selector
  trigger:
    platform: template
    value_template: "{{ states.sensor.monthly_amazon_temp_min.state != states.climate.octo_tank_therm.attributes.temperature.state }}"
  condition:
    condition: state
    entity_id: switch.06200940dc4f22cbb432_4
    state: 'off'
  action:
     service: climate.set_temperature
     data_template:
       entity_id: climate.octo_tank_therm
       temperature: '{{ states.sensor.monthly_amazon_temp_min.state | float }}'

 # This automation script runs when a value is received via Reef sensor: reef_low_avg_daily_temp
- alias: Set Reef Thermostat Max Daytime Selector
  trigger:
    platform: template
    value_template: "{{ states.sensor.reef_high_avg_daily_temp.state != states.climate.reef_tank_therm.attributes.temperature.state }}"
  condition:
    condition: state
    entity_id: input_boolean.reef_temp_daytime_state
    state: 'on'
  action:
     service: climate.set_temperature
     data_template:
       entity_id: climate.reef_tank_therm
       temperature: '{{ states.sensor.reef_high_avg_daily_temp.state | float }}'

 # This automation script runs when a value is received via Reef sensor: noaa_daily_min_reef_temp
- alias: Set Reef Thermostat Max Nighttime Selector
  trigger:
    platform: template
    value_template: "{{ states.sensor.noaa_daily_min_reef_temp.state != states.climate.reef_tank_therm.attributes.temperature.state }}"
  condition:
    condition: state
    entity_id: input_boolean.reef_temp_nightime_state
    state: 'on'
  action:
     service: climate.set_temperature
     data_template:
       entity_id: climate.reef_tank_therm
       temperature: '{{ states.sensor.noaa_daily_min_reef_temp.state | float }}'

- alias: Regulate Reef Heater To Off on Low Misread
  trigger:
    platform: template
    value_template: '{{ 32 == states.sensor.onlyreefcontrolpitemp.state }}'
  action:
    service: switch.turn_off
    entity_id: switch.06200940dc4f22cbb94b_3

- alias: Nightly Top OffOn
  trigger:
    - platform: time
      at: '22:00:00'
  action:
    service: switch.turn_on
    entity_id: switch.reef_pump_1_scheduled

- alias: Nightly Top OffOff
  trigger:
    - platform: time
      at: '1:00:00'
  action:
    service: switch.turn_off
    entity_id: switch.reef_pump_1_scheduled

#Turn on sump pump every 20 min
#- alias: Reef Sump Pump On Every Hour
#  trigger:
#    - platform: time_pattern
#      minutes: '/20'
#  condition:
#    condition: state
#    entity_id: sensor.reefcontrolpifloat
#    state: 'OK'
#  action:
#    service: switch.turn_on
#    entity_id: switch.2437254184f3eb695276

#Update Reef temps once a day
- alias: 'download_noaa_temps'
  trigger:
    - platform: time
      at: '01:16:00'
  action:
    - service: downloader.download_file
      data_template:
        url: "https://coralreefwatch.noaa.gov/vs/data/great_nicobar.txt"
        filename: "east_java_bali.txt"
        overwrite: true

#Turn on sump pump every 3 min
- alias: Reef Sump Pulse
  trigger:
    - platform: time_pattern
      minutes: '/4'
  condition:
    condition: state
    entity_id: sensor.reefcontrolpifloat
    state: 'OK'
  action:
    service: script.turn_on
    entity_id: script.reeftank_sump_pulse

#Turn sump pump off on low
- alias: Reef Sump Pump Low Off
  trigger:
    platform: state
    entity_id: sensor.reefcontrolpifloat
    from: 'OK'
    to: 'Low'
  action:
    service: switch.turn_off
    entity_id: switch.2437254184f3eb695276

#Turn sump pump off on low timer
- alias: Reef Sump Pump Low Timer
  trigger:
    platform: state
    entity_id: sensor.reefcontrolpifloat
    to: 'Low'
    for:
      minutes: 5
  action:
    service: switch.turn_off
    entity_id: switch.2437254184f3eb695276

## Herb Garden
- alias: Garden Turn On Lights
  trigger:
    - platform: time
      at: '06:00:00'
  action:
    service: switch.turn_on
    entity_id: switch.garden_light_manual

- alias: Garden Turn Lights Bugfix
  trigger:
    platform: numeric_state
    entity_id: sensor.garden_monitor_light_level
    below: 25
  condition:
    - condition: time
      after: '06:02:00'
      before: '20:58:00'
  action:
    service: switch.turn_on
    entity_id: switch.garden_light_manual

- alias: Garden Turn Off Lights
  trigger:
    - platform: time
      at: '21:00:00'
  action:
    service: switch.turn_off
    entity_id: switch.garden_light_manual

- alias: Garden Turn On Waterbot Morning
  trigger:
    - platform: time
      at: '7:03:00'
  action:
    service: switch.turn_on
    entity_id: switch.garden_waterbot

- alias: Garden Turn Off Waterbot Morning
  trigger:
    - platform: time
      at: '15:03:00'
  action:
    service: switch.turn_off
    entity_id: switch.garden_waterbot

#Alert if plants need water
- alias: ferns_needs_water
  trigger:
    platform: numeric_state
    entity_id: sensor.plant_monitor_soil_moisture
    below: 16
  condition:
    condition: and
    conditions:
      - condition: time
        before: '22:30:00'
        after: '09:30:00'
      - condition: template
        value_template: '{{ as_timestamp(now()) - as_timestamp(states.automation.ferns_needs_water.attributes.last_triggered) | int > 43200 }}'
  action:
    - service: notify.html5_push
      data:
        data:
          renotify: 1
          icon: https://thisisgabes.asuscomm.com:8008/local/icons/plant.png
          badge: https://thisisgabes.asuscomm.com:8008/local/icons/badge_plant.png
          timestamp: '%m'
          url: https://thisisgabes.asuscomm.com:8008/lovelace/6
          vibrate: 700, 700, 700
        message: "Your bedroom ferns need water. Soil moisture is currently at {{ states.sensor.plant_monitor_soil_moisture.state }}%"
        title: "I'm thirsty!"
        target:
          - "Gabes Mate"
          - "Macbook"
#    - service: ifttt.trigger
#      data_template: {"event":"plant_needs_water", "value1":"Bedroom Ferns", "value2":"{{ states.sensor.plant_monitor_soil_moisture.state }}"}
    - service: persistent_notification.create
      data:
        message: "Your bedroom ferns need water. Soil moisture is currently at {{ states.sensor.plant_monitor_soil_moisture.state }}%"
        title: "Bedroom Ferns Water Alert!"
- alias: plant_needs_water
  trigger:
    platform: numeric_state
    entity_id: sensor.garden_monitor_soil_moisture
    below: 10
  condition:
    condition: and
    conditions:
      - condition: time
        before: '22:30:00'
        after: '09:30:00'
      - condition: template
        value_template: '{{ as_timestamp(now()) - as_timestamp(states.automation.plant_needs_water.attributes.last_triggered) | int > 43200 }}'
  action:
    - service: notify.html5_push
      data:
        data:
          renotify: 1
          icon: https://thisisgabes.asuscomm.com:8008/local/icons/plant.png
          badge: https://thisisgabes.asuscomm.com:8008/local/icons/badge_plant.png
          timestamp: '%m'
          url: https://thisisgabes.asuscomm.com:8008/lovelace/6
          vibrate: 700, 700, 700
        message: "Your herb garden needs water. Soil moisture is currently at {{ states.sensor.garden_monitor_soil_moisture.state }}%"
        title: "I'm thirsty!"
        target:
          - "Gabes Mate"
          - "Macbook"
#    - service: ifttt.trigger
#      data_template: {"event":"plant_needs_water", "value1":"Hydroponic Garden", "value2":"{{ states.sensor.garden_monitor_soil_moisture.state }}"}
    - service: persistent_notification.create
      data:
        message: "Your herb garden needs water. Soil moisture is currently at {{ states.sensor.garden_monitor_soil_moisture.state }}%"
        title: "Hydroponic Garden Water Alert!"
- alias: empty_garden_drain
  trigger:
    platform: numeric_state
    entity_id: sensor.garden_monitor_water_level
    above: 60
  condition:
    condition: and
    conditions:
      - condition: time
        before: '22:30:00'
        after: '09:30:00'
      - condition: template
        value_template: '{{ as_timestamp(now()) - as_timestamp(states.automation.empty_garden_drain.attributes.last_triggered) | int > 43200 }}'
  action:
    - service: notify.html5_push
      data:
        data:
          renotify: 1
          icon: https://thisisgabes.asuscomm.com:8008/local/icons/plant.png
          badge: https://thisisgabes.asuscomm.com:8008/local/icons/badge_pipe.png
          timestamp: '%m'
          url: https://thisisgabes.asuscomm.com:8008/lovelace/6
          vibrate: 700, 700, 700
        message: "Empty the drainage reservoir soon. It is currently at {{ states.sensor.garden_monitor_water_level.state }}%"
        title: "Empty me!"
        target:
          - "Gabes Mate"
          - "Macbook"
#    - service: ifttt.trigger
#      data_template: {"event":"empty_garden_drain", "value1":"Hydroponic Garden", "value2":"{{ states.sensor.garden_monitor_water_level.state }}"}
    - service: persistent_notification.create
      data:
        message: "Empty the drainage reservoir soon. It is currently at {{ states.sensor.garden_monitor_water_level.state }}%"
        title: "Hydroponic Garden Reservoir Alert!"

## Alert if Garden Bot is down
- alias: garden_bot_alert
  trigger:
    platform: state
    entity_id: device_tracker.octocam
  condition:
    - condition: template
      value_template: "{{ trigger.to_state.state != trigger.from_state.state }}"
  action:
    - service: ifttt.trigger
      data_template: {"event":"change_of_ip", "value1":"GardenBot changed state to {{ states.device_tracker.octocam.state }}"}

## Vacuuming
- alias: Vacuum on Schedule
  trigger:
    platform: time
    at: '14:00:00'
  condition:
  - condition: time
    weekday:
      - tue
      - thu
  - condition: state
    entity_id: device_tracker.huawei_mate_9_92528f2b1a5
    state: work
  action:
    service: script.turn_on
    entity_id: script.roomba_turn_on


#Alert if public IP Changes
- alias: ip_change_alert
  trigger:
    platform: state
    entity_id: sensor.ip_address
  condition:
    - condition: template
      value_template: "{{ trigger.to_state.state != trigger.from_state.state }}"
  action:
    - service: ifttt.trigger
      data_template: {"event":"change_of_ip", "value1":"{{ states.sensor.ip_address.state }}"}

#Text Message if theres mail
- alias: usps_mail_alert
  trigger:
    platform: zone
    entity_id: device_tracker.huawei_mate_992528f2b1a5
    zone: zone.home
    event: enter
  condition:
    condition: or
    conditions:
      - condition: numeric_state
        entity_id: sensor.usps_mail
        above: '0' 
      - condition: numeric_state
        entity_id: sensor.usps_packages
        above: '0'
  action:
    - service: script.turn_on
      entity_id: script.usps_sms_notification

#Text Message if there's mail refresher on
- alias: usps_mail_alert_automation_on
  trigger:
    - platform: numeric_state
      entity_id: sensor.usps_mail
      above: '0'
    - platform: numeric_state
      entity_id: sensor.usps_packages
      above: '0'
  action:
    - service: automation.turn_on
      entity_id: automation.usps_mail_alert

#Text Message if there's mail refresher off
- alias: usps_mail_alert_automation_off
  trigger:
    - platform: numeric_state
      entity_id: sensor.usps_mail
      below: '1' 
  action:
    - service: automation.turn_off
      entity_id: automation.usps_mail_alert

#3D Printer Shutdown on Idle
- alias: Turn off 3D Printer on Idle
  trigger:
    platform: state
    entity_id: sensor.octoprint_target_tool1_temp
    to: '32'
#  condition:
#    condition: state
#    entity_id: binary_sensor.octoprint_status_printing
#    state: 'off'
  # Trigger only if state was this for last 30 minutes.
#    for:
#      minutes: 30
  action:
#    - delay:
#        minutes: 15
    - service: switch.turn_off
      entity_id: switch.2437254184f3eb695327

- id: 'rpi_power_issue'
  alias: Power Problem Notification
  trigger:
  - platform: numeric_state
    entity_id: sensor.rpi_power_status
    above: 0
    for:
      minutes: 1
  condition:
  action:
    service: persistent_notification.create
    data:
      message: "Charger reported {{ states.sensor.rpi_power_status.state }}"
      title: "RPI Power Issue"

#- alias: Check for Tweets OctoCam
#  id: twitter_check_octocam
#  trigger:
#    - platform: time_pattern
#      minutes: '/30'
#  action:
#    - service: shell_command.tweet_retrieve_octocam

#- alias: Check for Tweets SFGabe
#  id: twitter_check_sfgabe
#  trigger:
#    - platform: time_pattern
#      minutes: '/60'
#  action:
#    - service: shell_command.tweet_retrieve_sfgabe

## Alarm 2 test
- id: wake_up_alarm_2
  alias: Alarm clock
  initial_state: off
  trigger:
    platform: template
    value_template: "{{ states('sensor.time') == (((state_attr('input_datetime.bedroom_alarm_clock_time' , 'timestamp')) - (15 * 60))|timestamp_custom('%H:%M', false)) }}"
  condition:
    - condition: state
      entity_id: device_tracker.huawei_mate_9_92528f2b1a5
      state: 'home'
    - condition: state
      entity_id: input_boolean.bedroom_alarm_clock_status
      state: 'on'
  action:
    - service: script.turn_on
      data:
        entity_id: script.bedroom_wake_up

## IFTTT Test
- id: IFTTT_test
  alias: IFTTT Test
  trigger:
    platform: event
    event_type: ifttt_webhook_received
    event_data:
      action: call_service
  action:
    service_template: '{{ trigger.event.data.service }}'
    data_template:
      entity_id: '{{ trigger.event.data.entity_id }}'

- alias: Download Reef Stats File
  id: auto_download_reef_stats
  trigger:
    platform: time
    at: '20:15:00'
  action:
    - service: shell_command.download_reef_stats

- alias: Download Amazon Stats File
  id: auto_download_amazon_stats
  trigger:
    platform: time
    at: '20:16:00'
  action:
    - service: shell_command.download_amazon_stats

#Presence Detection Logic
- alias: Mark Gabe as just arrived
  trigger:
    - platform: state
      entity_id: group.gabe
      from: 'not_home'
      to: 'home'
  action:
    - service: input_select.select_option
      data:
        entity_id: input_select.gabe_status_dropdown
        option: Just Arrived
 
- alias: Mark Gabe as home
  trigger:
    - platform: state
      entity_id: input_select.gabe_status_dropdown
      to: 'Just Arrived'
      for:
        minutes: 10
    - platform: state
      entity_id: input_select.gabe_status_dropdown
      from: 'Just Left'
      to: 'Just Arrived'
  condition:
  action:
    - service: input_select.select_option
      data:
        entity_id: input_select.gabe_status_dropdown
        option: Home
 
- alias: Mark Gabe as just left
  trigger:
    - platform: state
      entity_id: group.gabe
      from: 'home'
      to: 'not_home'
  action:
    - service: input_select.select_option
      data:
        entity_id: input_select.gabe_status_dropdown
        option: Just Left
 
- alias: Mark Gabe as away
  trigger:
    - platform: state
      entity_id: input_select.gabe_status_dropdown
      to: 'Just Left'
      for:
        minutes: 10
  action:
    - service: input_select.select_option
      data:
        entity_id: input_select.gabe_status_dropdown
        option: Away

- alias: Mark Gabe as extended away
  trigger:
    - platform: state
      entity_id: input_select.gabe_status_dropdown
      to: 'Away'
      for:
        hours: 24
  action:
    - service: input_select.select_option
      data_template:
        entity_id: input_select.gabe_status_dropdown
        option: Extended Away

- alias: Request Mailbox Temp
  trigger:
    - platform: time_pattern
      minutes: '/5'
  action:
    service: script.turn_on
    entity_id: script.get_mailbox_temp

- alias: Mailbox Mail Flag On
  trigger:
    platform: numeric_state
    entity_id: sensor.usps_mail
    above: 0
  action:
    - service: homeassistant.turn_on
      data:
        entity_id: switch.mailbox_flag
    - service: homeassistant.turn_on
      data:
        entity_id: switch.mailbox_green_light

- alias: Mailbox Package Light On
  trigger:
    platform: numeric_state
    entity_id: sensor.usps_packages
    above: 0
  action:
    - service: homeassistant.turn_on
      data:
        entity_id: switch.mailbox_flag
    - service: homeassistant.turn_on
      data:
        entity_id: switch.mailbox_red_light

- alias: Mailbox Mail Flag Off
  trigger:
    platform: numeric_state
    entity_id: sensor.usps_mail
    below: 1
  action:
    - service: homeassistant.turn_off
      data:
        entity_id: switch.mailbox_flag
    - service: homeassistant.turn_off
      data:
        entity_id: switch.mailbox_green_light

- alias: Mailbox Package Light Off
  trigger:
    platform: numeric_state
    entity_id: sensor.usps_packages
    below: 1
  action:
    - service: homeassistant.turn_off
      data:
        entity_id: switch.mailbox_flag
    - service: homeassistant.turn_off
      data:
        entity_id: switch.mailbox_red_light

#Hue Dimmer Switch
- id: Hue Dimmer Switch 1 Click
  alias: Hue Dimmer Switch 1 Click
  trigger:
    - platform: state
      entity_id: sensor.hue_dimmer_switch_1
      to: "1_click"
  action:
    - service: scene.turn_on
      data:
        entity_id: scene.every_light_in_the_house

- id: Hue Dimmer Switch 2 Click
  alias: Hue Dimmer Switch 2 Click
  trigger:
    - platform: state
      entity_id: sensor.hue_dimmer_switch_1
      to: "2_click"
  action:
    service: script.turn_on
    entity_id: script.lights_loop

- id: Hue Dimmer Switch 3 Click
  alias: Hue Dimmer Switch 3 Click
  trigger:
    - platform: state
      entity_id: sensor.hue_dimmer_switch_1
      to: "3_click"
  action:
    service: script.turn_on
    entity_id: script.lights_chill_blue

- id: Hue Dimmer Switch 4 Click
  alias: Hue Dimmer Switch 4 Click
  trigger:
    - platform: state
      entity_id: sensor.hue_dimmer_switch_1
      to: "4_click"
  action:
    - service: homeassistant.turn_off
      data:
        entity_id: group.all_lightbulbs

- id: Hue Dimmer Switch 1 Click Up
  alias: Hue Dimmer Switch 1 Click Up
  trigger:
    - platform: state
      entity_id: sensor.hue_dimmer_switch_1
      to: "1_click_up"
  action:
    - service: scene.turn_on
      data:
        entity_id: scene.every_light_in_the_house

- id: Hue Dimmer Switch 2 Click Up
  alias: Hue Dimmer Switch 2 Click Up
  trigger:
    - platform: state
      entity_id: sensor.hue_dimmer_switch_1
      to: "2_click_up"
  action:
    service: script.turn_on
    entity_id: script.lights_loop

- id: Hue Dimmer Switch 3 Click Up
  alias: Hue Dimmer Switch 3 Click Up
  trigger:
    - platform: state
      entity_id: sensor.hue_dimmer_switch_1
      to: "3_click_up"
  action:
    service: script.turn_on
    entity_id: script.lights_chill_blue

- id: Hue Dimmer Switch 4 Click Up
  alias: Hue Dimmer Switch 4 Click Up
  trigger:
    - platform: state
      entity_id: sensor.hue_dimmer_switch_1
      to: "4_click_up"
  action:
    - service: homeassistant.turn_off
      data:
        entity_id: group.all_lightbulbs

#  Capture a frame every 10 minutes while the room is occupied
- alias : Room Auto Record
  trigger:
    platform: time_pattern
    minutes: '/10'
    seconds: 0
  condition:
    - condition: state
      entity_id: binary_sensor.people_home
      state: 'off'
    - condition: state
      entity_id: 'binary_sensor.room_occupied'
      state: 'on'
  action:
    - service: rest_command.trigger_snapshot_room

- alias: Motion Detection Alert On 
  trigger:
    - platform: state
      entity_id: binary_sensor.room_occupied
      from: 'off'
      to: 'on'
    - platform: state
      entity_id: binary_sensor.dashboard_motion
      from: 'off'
      to: 'on'
  condition:
    - condition: state
      entity_id: binary_sensor.people_home
      state: 'off'
  action:
    - service: switch.turn_on
      entity_id: switch.motion_text_change
    - service: rest_command.trigger_snapshot_room
    - delay: '00:00:04'
    - service: shell_command.motion_detect_get_latest
    - delay: '00:00:02'
    - service: notify.html5_push
      data:
        data:
          actions:
          - action: test_call_the_hounds
            title: Call the Hounds!
            icon: https://thisisgabes.asuscomm.com:8008/local/icons/badge_dog.png
          - action: dismiss
            title: Dismiss
            icon: https://thisisgabes.asuscomm.com:8008/local/icons/badge_dismiss.png
          image: "https://thisisgabes.asuscomm.com:8008/local/motion/recent-motion-overall.jpg"
          renotify: 1
          icon: https://thisisgabes.asuscomm.com:8008/local/icons/cctv.png
          badge: https://thisisgabes.asuscomm.com:8008/local/icons/badge_camera.png
          timestamp: '%m'
          url: https://thisisgabes.asuscomm.com:8008/states/group.homecams
          vibrate: 700, 700, 700
        message: "Motion in living room at {{ as_timestamp(now()) | timestamp_custom('%H:%M', true) }}"
        title: "Intruder Alert!"
        target:
          - "Gabes Mate"
          - "Macbook"
    - service: persistent_notification.create
      data:
        message: "I have detected motion in you living room!"
        title: "Intruder Alert!"

#Hounds Alarm
- alias: hound_alarm
  trigger:
  - event_data:
      action: test_call_the_hounds
    event_type: html5_notification.clicked
    platform: event
  action:
  - entity_id: switch.call_the_hounds
    service: switch.turn_on

# Alert if Offline
- alias: Alert when device goes offline
  trigger:
    - platform: state
      entity_id: sensor.online_device_amazon_echo, sensor.online_device_mailbox, sensor.online_device_harmony_hub, sensor.online_device_homecam_pi, sensor.online_device_octoprint, sensor.online_device_phillips_hue,  sensor.online_device_entry_pi, sensor.online_device_reefcam_pantilt, sensor.online_device_reef_pi, sensor.online_device_entry_kiosk, sensor.online_device_gardenbot, sensor.online_device_plant_monitor
      from: 'Online'
      to: 'Offline'
      for:
        minutes: 60
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: >
          {% if states.automation.alert_when_device_goes_offline.last_triggered is not none %}
            {% if as_timestamp(now()) | int   -  as_timestamp(states.automation.alert_when_device_goes_offline.attributes.last_triggered) | int > 3600 %} true {% else %} false
            {% endif %}
          {% else %}
          false
          {% endif %}
  action:
    - service: ifttt.trigger
      data_template: {"event":"change_of_ip", "value1":"{{trigger.to_state.attributes.friendly_name}} has been offline for 1 hour. Please check the status of this device."}

# Harmony Soundbar
- id: samsung_soundbar_power
  alias: 'Soundbar'
  trigger: 
    platform: state
    entity_id: input_boolean.samsung_soundbar_power   #### Triggered by either turning on or off the input_boolen
  action:
    service: remote.send_command
    data_template:
      entity_id: remote.gabes_harmony_hub
      device: 29883813
      command: >
        {% if is_state(trigger.entity_id, 'on') %}
          PowerOn
        {% else %}
          PowerOff
        {% endif %}

- alias: Samsung Soundbar Volume (Media to Slider)
  trigger:
    - platform: state
      entity_id: media_player.yamaha_receiver
  action:
     service: input_number.set_value
     data_template:
       entity_id: input_number.samsung_soundbar
       value: >
          {{ ( ( -1.0 + trigger.to_state.attributes.volume_level | float ) * 100.0 ) | round(0.0) }}

- alias: Samsung Soundbar Volume (Slider to Media)
  trigger:
    - platform: state
      entity_id: input_number.samsung_soundbar
  action:
    - service: media_player.volume_set
      data_template:
        entity_id: media_player.yamaha_receiver
        volume_level: >
          {{ (1.0 - trigger.to_state.state | float / 100.0) | round(2) }}

#Humidifier Switch through Alexa routine
- alias: Turn on Humidifier
  trigger:
    - platform: state
      entity_id: input_boolean.humidifier_toggle
      to: 'on'
  action:
    - service: script.turn_on
      entity_id: script.alexa_humidifier_on
- alias: Turn off Humidifier
  trigger:
    - platform: state
      entity_id: input_boolean.humidifier_toggle
      to: 'off'
  action:
    - service: script.turn_on
      entity_id: script.alexa_humidifier_off

- alias: Homecam Snapshot Momentary
  trigger:
    - platform: state
      entity_id: input_boolean.homecam_snapshot
      to: 'on'
  action:
    - service: rest_command.trigger_snapshot_room
    - delay: '00:00:02'
    - service: input_boolean.turn_off
      entity_id: input_boolean.homecam_snapshot

#thundercloud
- alias: "Porch Animation Speed"
  initial_state: True
  hide_entity: False
  trigger:
    - platform: state
      entity_id: input_number.thundercloud_animation_speed
  action:
    - service: mqtt.publish
      data_template:
        topic: "thundercloud/reading/set"
        payload: '{"transition":{{ trigger.to_state.state | int }}}'

- alias: Lightning Warning
  trigger:
    - platform: geo_location
      source: wwlln
      zone: zone.home
      event: enter
  action:
    - service: persistent_notification.create
      data_template:
        message: "{{ trigger.to_state.name }} - {{ trigger.to_state.attributes.status }}, as of {{ trigger.to_state.attributes.publication_date }}"
        title: "Oooooh! Lightning!"
    - service: script.turn_on
      entity_id: script.lightning_burst